---
title: Docker部署nextjs项目
date: 2023-07-27
tags: [docker, nextjs, web]
draft: false
summary: 关于这个blog使用docker部署的过程
---

## 前言

本博客使用nextjs作为前端框架，使用docker部署。

<TOCInline toc={props.toc} exclude="Overview" toHeading={2} />

## Dockerfile 内容

```Dockerfile:Dockerfile
FROM node:20.15.1-alpine AS base

ENV NODE_ENV production
ENV APP_PATH /app


# 添加源
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat

RUN npm uninstall yarn -g \
    && corepack enable \
    && corepack prepare yarn@3.6.1 --activate \
    && yarn config set --json -H unsafeHttpWhitelist '["*.npmjs.org"]'  \
    && yarn config set -H   enableStrictSsl false \
    && yarn config set -H  npmRegistryServer https://registry.npm.taobao.org

FROM base AS builder
WORKDIR $APP_PATH
COPY ./ ./
RUN yarn install && yarn build


FROM base AS runner
WORKDIR $APP_PATH

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# ADD  --chown=nextjs:nodejs ./.next/standalone ./
# ADD   ./public  ./public
# ADD  --chown=nextjs:nodejs ./.next/static ./.next/static
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs $APP_PATH/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs $APP_PATH/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"
# server.js is created by next build from the standalone output
# https://nextjs.org/docs/pages/api-reference/next-config-js/output
CMD HOSTNAME="0.0.0.0" node server.js
```
