---
title: Dockeréƒ¨ç½²nextjsé¡¹ç›®
date: 2023-07-27
tags: [docker, nextjs, web]
draft: false
summary: æœ¬åšå®¢ä½¿ç”¨nextjsä½œä¸ºå‰ç«¯æ¡†æ¶ï¼Œä½¿ç”¨dockeréƒ¨ç½²,ä½¿ç”¨äº†tailwind cssçš„ä¸€ä¸ªæ¨¡æ¿ã€‚è®°å½•ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨Dockeréƒ¨ç½²ä¸€ä¸ªNext.jsé¡¹ç›®ã€‚é€šè¿‡ä½¿ç”¨Dockerï¼Œæˆ‘ä»¬å¯ä»¥å°†åº”ç”¨ç¨‹åºä¸å…¶ä¾èµ–é¡¹æ‰“åŒ…æˆä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒï¼Œæ–¹ä¾¿åœ¨ä»»ä½•æ”¯æŒDockerçš„ç¯å¢ƒä¸­è¿è¡Œã€‚
---

## å‰è¨€

æœ¬åšå®¢ä½¿ç”¨nextjsä½œä¸ºå‰ç«¯æ¡†æ¶ï¼Œä½¿ç”¨dockeréƒ¨ç½²,ä½¿ç”¨äº†tailwind cssçš„ä¸€ä¸ªæ¨¡æ¿ã€‚
è®°å½•ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨Dockeréƒ¨ç½²ä¸€ä¸ªNext.jsé¡¹ç›®ã€‚é€šè¿‡ä½¿ç”¨Dockerï¼Œæˆ‘ä»¬å¯ä»¥å°†åº”ç”¨ç¨‹åºä¸å…¶ä¾èµ–é¡¹æ‰“åŒ…æˆä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒï¼Œæ–¹ä¾¿åœ¨ä»»ä½•æ”¯æŒDockerçš„ç¯å¢ƒä¸­è¿è¡Œã€‚

<TOCInline toc={props.toc} exclude="Overview" toHeading={2} />

### åˆ›å»ºDockerfile

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª`Dockerfile`æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹`Dockerfile`ï¼Œè¯¥æ–‡ä»¶åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š`base`ã€`builder`å’Œ`runner`ã€‚

```Dockerfile:Dockerfile

# ä½¿ç”¨Node.jsçš„alpineç‰ˆæœ¬ä½œä¸ºåŸºç¡€é•œåƒï¼Œæ„å»ºé•œåƒæ—¶å‡å°ä½“ç§¯
FROM node:20.15.1-alpine AS base


# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV production
ENV APP_PATH /app


# æ·»åŠ æº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…å¿…è¦çš„å…¼å®¹åŒ…
RUN apk add --no-cache libc6-compat

# é…ç½®Yarnï¼Œç§»é™¤å…¨å±€çš„æ—§ç‰ˆæœ¬å¹¶å¯ç”¨corepackç®¡ç†
RUN npm uninstall yarn -g \
    && corepack enable \
    && corepack prepare yarn@3.6.1 --activate \
    && yarn config set --json -H unsafeHttpWhitelist '["*.npmjs.org"]'  \
    && yarn config set -H   enableStrictSsl false \
    && yarn config set -H  npmRegistryServer https://registry.npm.taobao.org

# æ„å»ºé˜¶æ®µï¼Œå®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®
FROM base AS builder
WORKDIR $APP_PATH
COPY ./ ./
RUN yarn install && yarn build

# è¿è¡Œé˜¶æ®µï¼Œåˆ›å»ºç”¨æˆ·å¹¶å°†æ„å»ºæ–‡ä»¶æ‹·è´åˆ°é•œåƒä¸­
FROM base AS runner
WORKDIR $APP_PATH

# åˆ›å»ºnodejsç»„å’Œnextjsç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# å¤åˆ¶æ„å»ºè¾“å‡ºåˆ°è¿è¡Œç¯å¢ƒ
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs $APP_PATH/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs $APP_PATH/.next/static ./.next/static

# è®¾ç½®ç”¨æˆ·ä¸ºnextjs
USER nextjs

# æš´éœ²ç«¯å£3000
EXPOSE 3000

# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# ä½¿ç”¨nodeå¯åŠ¨Next.jsæœåŠ¡
CMD HOSTNAME="0.0.0.0" node server.js
```

### Dockerfileè§£æ

#### Baseé˜¶æ®µ

1. åŸºç¡€é•œåƒï¼š ä½¿ç”¨node:20.15.1-alpineä½œä¸ºåŸºç¡€é•œåƒã€‚
2. æ›´æ¢é•œåƒæºï¼š ä¸ºäº†åŠ å¿«ä¸‹è½½é€Ÿåº¦ï¼Œå°†é»˜è®¤çš„alpinelinuxæºæ›´æ”¹ä¸ºé˜¿é‡Œäº‘çš„é•œåƒã€‚
3. å®‰è£…ä¾èµ–ï¼š ä½¿ç”¨apkå®‰è£…libc6-compatä»¥ç¡®ä¿å…¼å®¹æ€§ã€‚
4. é…ç½®Yarnï¼š é¡¹ç›®ä½¿ç”¨yarn:2.\*æ„å»ºï¼Œå…ˆç§»é™¤æ—§ç‰ˆæœ¬yarnï¼Œé€šè¿‡corepackå¼€å¯æ–°ç‰ˆæœ¬yarnï¼Œ è®¾ç½®ä¸ºä½¿ç”¨æ·˜å®é•œåƒæºä»¥åŠ å¿«ä¾èµ–çš„ä¸‹è½½é€Ÿåº¦

#### builderé˜¶æ®µ

1. åˆ›å»ºç”¨æˆ·å’Œç»„ï¼š ä¸ºäº†å®‰å…¨æ€§ï¼Œåˆ›å»ºä¸€ä¸ªç”¨æˆ·nextjså’Œç»„nodejsï¼Œå¹¶åœ¨åç»­é˜¶æ®µè®¾ç½®åº”ç”¨ç¨‹åºçš„è¿è¡Œç”¨æˆ·ã€‚
2. å¤åˆ¶æ„å»ºæ–‡ä»¶ï¼š å°†æ„å»ºé˜¶æ®µç”Ÿæˆçš„é™æ€èµ„æºæ–‡ä»¶å’Œé¡¹ç›®çš„å¯æ‰§è¡Œæ–‡ä»¶æ‹·è´åˆ°è¿è¡Œç¯å¢ƒä¸­ã€‚
3. å¯åŠ¨åº”ç”¨ï¼š ä½¿ç”¨node server.jså¯åŠ¨åº”ç”¨ï¼Œç›‘å¬0.0.0.0:3000ç«¯å£ã€‚

### æ„å»ºå’Œè¿è¡ŒDockeré•œåƒ

```bash
# æ„å»ºDockeré•œåƒ
docker build -t moonhou/ifcat:[version] .

# è¿è¡Œå®¹å™¨
docker run -d --name ifcat -p 3000:3000 moonhou/ifcat:[version]
```

### æ€»ç»“

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†Next.jsé¡¹ç›®æ‰“åŒ…ä¸ºDockeré•œåƒï¼Œå¹¶éƒ¨ç½²åˆ°ä»»ä½•æ”¯æŒDockerçš„ç¯å¢ƒä¸­ã€‚ä»¥ä¸Šæ­¥éª¤ä¸ä»…èƒ½å¤Ÿç®€åŒ–å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹ï¼Œè¿˜èƒ½ç¡®ä¿é¡¹ç›®åœ¨ä¸åŒç¯å¢ƒä¸­è¿è¡Œçš„ä¸€è‡´æ€§ã€‚  
å½“ç„¶ï¼Œåšå®¢æ˜¯éƒ¨ç½²åœ¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥æœ¬åœ°å¼€å‘åˆ°è¿œç¨‹éƒ¨ç½²è¿™ä¸­é—´ä¼šå¾ˆéº»çƒ¦ã€‚  
ä¸€å¼€å§‹æˆ‘æ˜¯è‡ªå·±æ‰“åŒ…é•œåƒç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨æ‰‹åŠ¨é‡æ–°éƒ¨ç½²ï¼Œåè¾¹ä½¿ç”¨github actionè‡ªåŠ¨å®Œæˆäº†è¿™ä¸­é—´æµç¨‹ï¼Œå…·ä½“ç»†èŠ‚åç»­ä¼šå‡ºä¸€ç¯‡æ–°çš„æ–‡ç« ä»‹ç»ã€‚  
ä¸è¿‡åœ¨é‡æ–°éƒ¨ç½²æ—¶ä¼šçŸ­æš‚åœæœºï¼Œè¿™ä¸ªé—®é¢˜è¿˜æ²¡å¤„ç†ï¼Œä¸è¿‡ç½‘ç«™æ²¡ä»€ä¹ˆæµé‡ï¼Œè¿™ç®—æ˜¯å°é—®é¢˜äº†ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆğŸ˜‚ã€‚
